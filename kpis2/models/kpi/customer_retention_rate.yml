version: 2

models:
  - name: customer_retention_rate
    description: |
      This model calculates the Customer Retention Rate KPI.
      Definition: Percentage of customers who remain subscribed to services over a defined period.
    columns:
      - name: customer_retention_rate
        description: "The retention rate calculated as (retained customers / total customers) * 100."
      - name: retained_customers
        description: "The number of customers who remained subscribed until the end of the period (i.e., those with no end_date or an end_date on or after the period end date)."
      - name: total_customers
        description: "The total number of customers who were active at the start of the period (i.e., those with start_date on or before the period start date and still active on the period start date)."

    meta:
      kpi:
        name: Customer Retention Rate
        definition: "Percentage of customers who remain subscribed to services over a defined period."
        formula: |
          ((SELECT COUNT(DISTINCT customer_id) FROM prv_service_assignments
            WHERE start_date <= @PeriodStart
              AND (end_date IS NULL OR end_date >= @PeriodEnd))
          /
          (SELECT COUNT(DISTINCT customer_id) FROM prv_service_assignments
            WHERE start_date <= @PeriodStart
              AND (end_date IS NULL OR end_date >= @PeriodStart))) * 100
